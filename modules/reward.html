<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Reward | Crypto.com Chain</title>
    <meta name="description" content="Welcome to Crypto.com Chain&#39;s documentation!">
    <meta name="generator" content="VuePress 1.3.0">
    
    
    <link rel="preload" href="/assets/css/0.styles.4c9036fb.css" as="style"><link rel="preload" href="/assets/js/app.87b9d60e.js" as="script"><link rel="preload" href="/assets/js/2.f6144b7e.js" as="script"><link rel="preload" href="/assets/js/31.c62e85d2.js" as="script"><link rel="prefetch" href="/assets/js/10.1cdea379.js"><link rel="prefetch" href="/assets/js/11.b81d5b6e.js"><link rel="prefetch" href="/assets/js/12.ebcf529d.js"><link rel="prefetch" href="/assets/js/13.808bce9e.js"><link rel="prefetch" href="/assets/js/14.e2912e35.js"><link rel="prefetch" href="/assets/js/15.60461254.js"><link rel="prefetch" href="/assets/js/16.5fe5db6e.js"><link rel="prefetch" href="/assets/js/17.84cca1c2.js"><link rel="prefetch" href="/assets/js/18.825a3de8.js"><link rel="prefetch" href="/assets/js/19.f9142acf.js"><link rel="prefetch" href="/assets/js/20.3e73af9d.js"><link rel="prefetch" href="/assets/js/21.aba308fd.js"><link rel="prefetch" href="/assets/js/22.83321bcb.js"><link rel="prefetch" href="/assets/js/23.b04b2df4.js"><link rel="prefetch" href="/assets/js/24.681f9c6c.js"><link rel="prefetch" href="/assets/js/25.be3144a2.js"><link rel="prefetch" href="/assets/js/26.5db2f66c.js"><link rel="prefetch" href="/assets/js/27.25665eb5.js"><link rel="prefetch" href="/assets/js/28.70d083de.js"><link rel="prefetch" href="/assets/js/29.4727a189.js"><link rel="prefetch" href="/assets/js/3.c61d9941.js"><link rel="prefetch" href="/assets/js/30.d03015d5.js"><link rel="prefetch" href="/assets/js/32.63f06b33.js"><link rel="prefetch" href="/assets/js/33.8ba9d6b5.js"><link rel="prefetch" href="/assets/js/34.c447f9e1.js"><link rel="prefetch" href="/assets/js/35.8491695c.js"><link rel="prefetch" href="/assets/js/36.14947c5d.js"><link rel="prefetch" href="/assets/js/37.4441c601.js"><link rel="prefetch" href="/assets/js/4.98fec9a1.js"><link rel="prefetch" href="/assets/js/5.dddf6e84.js"><link rel="prefetch" href="/assets/js/6.c42000b0.js"><link rel="prefetch" href="/assets/js/7.adda006a.js"><link rel="prefetch" href="/assets/js/8.a5d62fc4.js"><link rel="prefetch" href="/assets/js/9.7c0971f5.js">
    <link rel="stylesheet" href="/assets/css/0.styles.4c9036fb.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container no-sidebar"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/" class="home-link router-link-active"><!----> <span class="site-name">Crypto.com Chain</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/" class="nav-link">
  Home
</a></div><div class="nav-item"><a href="/getting-started/" class="nav-link">
  Getting Started
</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="Thaler Testnet" class="dropdown-title"><span class="title">Thaler Testnet</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/getting-started/thaler-testnet.html" class="nav-link">
  Setup Tutorial
</a></li><li class="dropdown-item"><!----> <a href="https://chain.crypto.com/explorer" target="_blank" rel="noopener noreferrer" class="nav-link external">
  Testnet Explorer
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li><li class="dropdown-item"><!----> <a href="https://chain.crypto.com/explorer/faucet" target="_blank" rel="noopener noreferrer" class="nav-link external">
  Testnet Faucet
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="Wallet Management" class="dropdown-title"><span class="title">Wallet Management</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/wallets/#client-cli" class="nav-link">
  Overview
</a></li><li class="dropdown-item"><!----> <a href="/wallets/client-cli.html#client-cli" class="nav-link">
  Client CLI
</a></li><li class="dropdown-item"><!----> <a href="/wallets/sample-chain-wallet.html#sample-chain-wallet" class="nav-link">
  Sample Chain Wallet
</a></li><li class="dropdown-item"><!----> <a href="/wallets/client-rpc.html#client-rpc" class="nav-link">
  Client RPC
</a></li></ul></div></div><div class="nav-item"><a href="https://crypto-com.github.io/Crypto.com_Chain.pdf" target="_blank" rel="noopener noreferrer" class="nav-link external">
  Download
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></div> <!----></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/" class="nav-link">
  Home
</a></div><div class="nav-item"><a href="/getting-started/" class="nav-link">
  Getting Started
</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="Thaler Testnet" class="dropdown-title"><span class="title">Thaler Testnet</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/getting-started/thaler-testnet.html" class="nav-link">
  Setup Tutorial
</a></li><li class="dropdown-item"><!----> <a href="https://chain.crypto.com/explorer" target="_blank" rel="noopener noreferrer" class="nav-link external">
  Testnet Explorer
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li><li class="dropdown-item"><!----> <a href="https://chain.crypto.com/explorer/faucet" target="_blank" rel="noopener noreferrer" class="nav-link external">
  Testnet Faucet
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="Wallet Management" class="dropdown-title"><span class="title">Wallet Management</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/wallets/#client-cli" class="nav-link">
  Overview
</a></li><li class="dropdown-item"><!----> <a href="/wallets/client-cli.html#client-cli" class="nav-link">
  Client CLI
</a></li><li class="dropdown-item"><!----> <a href="/wallets/sample-chain-wallet.html#sample-chain-wallet" class="nav-link">
  Sample Chain Wallet
</a></li><li class="dropdown-item"><!----> <a href="/wallets/client-rpc.html#client-rpc" class="nav-link">
  Client RPC
</a></li></ul></div></div><div class="nav-item"><a href="https://crypto-com.github.io/Crypto.com_Chain.pdf" target="_blank" rel="noopener noreferrer" class="nav-link external">
  Download
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></div> <!----></nav>  <!----> </aside> <main class="page"> <div class="theme-default-content content__default"><h1 id="reward"><a href="#reward" class="header-anchor">#</a> Reward</h1> <h2 id="abstract"><a href="#abstract" class="header-anchor">#</a> Abstract</h2> <p>Rewarding module enable crypto chain to reward protocol participators, the design should meet following requirements:</p> <ul><li>The total supply of CRO is fixed.</li> <li>The distribution should be &quot;fair&quot;, i.e. all honest participators should get rewards, non-participators should not, and the amount of rewards get distributed to a validator should be proportional to it's contribution (sum of the voting power of each vote).</li> <li>The newly emitted coins for rewarding is adjusted according to <a href="#total-staking">total staking</a> and current block time.</li></ul> <p>The basic procedure is:</p> <ul><li>Record participators for each block, sum the voting powers for each participator at the vote time.</li> <li>Distribute the accumulated reward pool according to the recorded sum powers at the end of reward period.</li></ul> <p>For example, in one reward period with N blocks, validator <code>A</code> only participate in the first block, and all the other validators participate in all blocks, assuming the validator set is static during this period, then we have:</p> <div class="language- extra-class"><pre class="language-text"><code>p: voting power of validator A
p': sum of voting power of all other validators

block1: participators: p', p
block2: participators: p'
block3: participators: p'
...
blockN: participators: p'

# The rewards of A is:
reward_a = reward_pool * p / (p + p' * N)
</code></pre></div><p>The result of reward distribution should be written into events of block results.</p> <h3 id="concepts"><a href="#concepts" class="header-anchor">#</a> Concepts</h3> <h4 id="reward-participator"><a href="#reward-participator" class="header-anchor">#</a> Reward participator</h4> <p>All the validators who follow the protocol honestly should participate in the reward distribution.</p> <p>In tendermint's terms, following the protocol honestly means being a signed voter in <code>last_commit_info</code> of <code>BeginBlockRequest</code>.</p> <p>It can be described precisely as:</p> <div class="language-rust extra-class"><pre class="language-rust"><code>begin_block_req
  <span class="token punctuation">.</span>last_commit_info
  <span class="token punctuation">.</span>votes
  <span class="token punctuation">.</span><span class="token function">filter</span><span class="token punctuation">(</span><span class="token operator">|</span>vote<span class="token operator">|</span> vote<span class="token punctuation">.</span>signed_last_block<span class="token punctuation">)</span>
</code></pre></div><h4 id="reward-period"><a href="#reward-period" class="header-anchor">#</a> Reward period</h4> <p>Rewards are distributed to the validators periodically, the length of the period is configured in network parameter <code>reward_period_seconds</code> in genesis config.</p> <h4 id="reward-pool"><a href="#reward-pool" class="header-anchor">#</a> Reward pool</h4> <p>During the reward period, the following sources of funds are accumulated into reward pool:</p> <ul><li><a href="#monetary-expansion">Monetary expansion</a></li> <li><a href="/getting-started/transaction.html#transaction-fees">Transaction Fees</a></li> <li>Slashings</li></ul> <p>The reward pool gets accumulated throughout the whole reward period; it gets distributed once at the end of each reward period.</p> <p>Due to fixed point calculations, there may be a few remainders from arithmetic operations after distribution. These remainder amounts should be left in the rewards pool for the next period.</p> <p>If there is zero participant for the period, the rewards pool should be left to the next period, rather than get burned.</p> <h4 id="total-staking"><a href="#total-staking" class="header-anchor">#</a> Total staking</h4> <p>The sum of bonded coins of all active validators at some block.</p> <h4 id="monetary-expansion"><a href="#monetary-expansion" class="header-anchor">#</a> Monetary expansion</h4> <p>New coins are minted into the reward pool at the end of reward period.</p> <p>The amount is calculated based on the total staking of current state and current block time.</p> <p>The total minted coins for rewarding shouldn't exceed the amount configured in network parameter <code>monetary_expansion_cap</code>.</p> <p>The calculation is as follows:</p> <div class="language-python extra-class"><pre class="language-python"><code>R0 <span class="token operator">=</span> network_parameter<span class="token punctuation">[</span><span class="token string">&quot;monetary_expansion_r0&quot;</span><span class="token punctuation">]</span>  <span class="token comment"># upper bound for the reward rate p.a.</span>
P <span class="token operator">=</span> network_parameter<span class="token punctuation">[</span><span class="token string">&quot;reward_period_seconds&quot;</span><span class="token punctuation">]</span>
tau <span class="token operator">=</span> current tau  <span class="token comment"># refer to section &quot;Decay of parameter tau&quot;</span>
S <span class="token operator">=</span> total staking  <span class="token comment"># refer to section &quot;Total staking&quot;</span>
Y <span class="token operator">=</span> <span class="token number">365</span> <span class="token operator">*</span> <span class="token number">24</span> <span class="token operator">*</span> <span class="token number">60</span> <span class="token operator">*</span> <span class="token number">60</span>  <span class="token comment"># seconds of a year</span>

CAP <span class="token operator">=</span> network_parameter<span class="token punctuation">[</span><span class="token string">&quot;monetary_expansion_cap&quot;</span><span class="token punctuation">]</span>
minted <span class="token operator">=</span> total minted coins so far  <span class="token comment"># recorded in state</span>

R <span class="token operator">=</span> <span class="token punctuation">(</span>R0 <span class="token operator">/</span> <span class="token number">1000</span><span class="token punctuation">)</span> <span class="token operator">*</span> exp<span class="token punctuation">(</span><span class="token operator">-</span>S <span class="token operator">/</span> tau<span class="token punctuation">)</span>
N <span class="token operator">=</span> floor<span class="token punctuation">(</span>S <span class="token operator">*</span> <span class="token punctuation">(</span><span class="token builtin">pow</span><span class="token punctuation">(</span><span class="token number">1</span> <span class="token operator">+</span> R<span class="token punctuation">,</span> P <span class="token operator">/</span> Y<span class="token punctuation">)</span> <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
N <span class="token operator">=</span> N <span class="token operator">-</span> N <span class="token operator">%</span> <span class="token number">10000</span>  <span class="token comment"># less precision requirement</span>
result <span class="token operator">=</span> <span class="token builtin">min</span><span class="token punctuation">(</span>N<span class="token punctuation">,</span> CAP <span class="token operator">-</span> minted<span class="token punctuation">)</span>  <span class="token comment"># the amount of newly minted coins</span>
</code></pre></div><h4 id="decay-of-parameter-tau"><a href="#decay-of-parameter-tau" class="header-anchor">#</a> Decay of parameter tau</h4> <p>The parameter <code>tau</code> in the monetary expansion calculation should be initialized to network parameter <code>monetary_expansion_tau</code> and gets decayed for each reward distribution.</p> <p>The rate of decaying is configured in network parameter <code>monetary_expansion_decay</code>.</p> <p>The calculation is like this:</p> <div class="language-python extra-class"><pre class="language-python"><code>rate <span class="token operator">=</span> network_parameter<span class="token punctuation">[</span><span class="token string">&quot;monetary_expansion_decay&quot;</span><span class="token punctuation">]</span>

<span class="token comment"># init</span>
tau <span class="token operator">=</span> network_parameter<span class="token punctuation">[</span><span class="token string">&quot;monetary_expansion_tau&quot;</span><span class="token punctuation">]</span>

<span class="token comment"># decay</span>
tau <span class="token operator">=</span> tau <span class="token operator">*</span> rate <span class="token operator">/</span> <span class="token number">1000</span>
</code></pre></div><p>To prevent overflow of integer multiplication, it can be transformed into:</p> <div class="language-python extra-class"><pre class="language-python"><code>tau <span class="token operator">=</span> <span class="token punctuation">(</span>tau <span class="token operator">/</span> <span class="token number">1000</span><span class="token punctuation">)</span> <span class="token operator">*</span> rate <span class="token operator">+</span> <span class="token punctuation">(</span>tau <span class="token operator">%</span> <span class="token number">1000</span><span class="token punctuation">)</span> <span class="token operator">*</span> rate
</code></pre></div><h4 id="fixed-point-arithmetic"><a href="#fixed-point-arithmetic" class="header-anchor">#</a> Fixed point arithmetic</h4> <p>We should use continued fraction method to compute the <code>exp</code> and <code>pow</code> with fixed point arithmetics.</p> <p>First we transform the power function into exponential and natural logarithm functions:</p> <div class="language- extra-class"><pre class="language-text"><code>pow(x, y) = exp(y * log(x))
</code></pre></div><p>The <code>exp</code> and <code>log</code> are computed with continued fractions representation, using a form with better convergence:</p> <div class="language- extra-class"><pre class="language-text"><code>exp2(x, y) = exp(x / y)
log2(x, y) = log(1 + x / y)
</code></pre></div><p><img src="https://wikimedia.org/api/rest_v1/media/math/render/svg/7aa8187974263e0f3e7cc293ca82d3dc3d75af90" alt="MainEq1"></p> <p><img src="https://wikimedia.org/api/rest_v1/media/math/render/svg/90abfa2132828fc8eea5d3551dfa4df25dbdfa87" alt="MainEq2"></p> <p>With above substitutes, we can transform the formula like this:</p> <div class="language- extra-class"><pre class="language-text"><code>R = (R0 / 1000) * exp(-S/tau)
  = R0 * exp2(-S, tau) / 1000
N = S * (pow(1 + R, P / Y) - 1)
  = S * (exp(P * log(1 + R) / Y) - 1)
  = S * (exp2(P * log(1 + R), Y) - 1)
  = S * (exp2(P * log(1 + R0 * exp2(-S, tau) / 1000), Y) - 1)
  = S * (exp2(P * log2(R0 * exp2(-S, tau), 1000), Y) - 1)
</code></pre></div><p>Break it down into simpler computation steps:</p> <div class="language- extra-class"><pre class="language-text"><code># To keep the intermediate numbers smaller
S' = S / 10000000_00000000
tau' = tau / 10000000_00000000

n0 = exp2(-S', tau')
n1 = log2(R0 * n0, 1000)
n2 = exp2(P * n1, Y)
n3 = floor(S * (n2 - 1))
N  = n3 - n3 % 10000
</code></pre></div><blockquote><p>Fixed point number format: <code>I65F63</code>.</p> <p><code>exp2</code> runs 25 iterations.</p> <p><code>log2</code> runs 10 iterations.</p></blockquote> <p>TODO, how to compute the continued fractions form of <code>exp2</code> and <code>log2</code>.</p> <h2 id="implementation"><a href="#implementation" class="header-anchor">#</a> Implementation</h2> <h3 id="network-parameters"><a href="#network-parameters" class="header-anchor">#</a> Network parameters</h3> <div class="language-rust extra-class"><pre class="language-rust"><code><span class="token keyword">pub</span> <span class="token keyword">struct</span> RewardsParameters <span class="token punctuation">{</span>
    <span class="token comment">/// Reward period in seconds</span>
    <span class="token keyword">pub</span> reward_period_seconds<span class="token punctuation">:</span> u64<span class="token punctuation">,</span>

    <span class="token comment">/// Maximum minted coins for rewards</span>
    <span class="token keyword">pub</span> monetary_expansion_cap<span class="token punctuation">:</span> Coin<span class="token punctuation">,</span>
    <span class="token comment">/// Monetary expansion formula parameter R0</span>
    <span class="token keyword">pub</span> monetary_expansion_r0<span class="token punctuation">:</span> Milli<span class="token punctuation">,</span>
    <span class="token comment">/// Monetary expansion formula parameter tau</span>
    <span class="token keyword">pub</span> monetary_expansion_tau<span class="token punctuation">:</span> u64<span class="token punctuation">,</span>

    <span class="token comment">/// Decay rate of the parameter tau</span>
    <span class="token keyword">pub</span> monetary_expansion_decay<span class="token punctuation">:</span> u64<span class="token punctuation">,</span>
<span class="token punctuation">}</span>
</code></pre></div><p>Validation of <code>RewardsParameters</code>:</p> <div class="language-rust extra-class"><pre class="language-rust"><code><span class="token keyword">impl</span> RewardsParameters <span class="token punctuation">{</span>
    <span class="token keyword">pub</span> <span class="token keyword">fn</span> <span class="token function">validate</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token keyword">self</span><span class="token punctuation">)</span> <span class="token punctuation">-&gt;</span> Result<span class="token operator">&lt;</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span><span class="token lifetime-annotation symbol">'static</span> str<span class="token operator">&gt;</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token keyword">self</span><span class="token punctuation">.</span>monetary_expansion_r0 <span class="token operator">&gt;</span> Milli<span class="token punctuation">::</span><span class="token function">integral</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span> <span class="token function">Err</span><span class="token punctuation">(</span><span class="token string">&quot;R0 can't &gt; 1&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">if</span> <span class="token keyword">self</span><span class="token punctuation">.</span>monetary_expansion_tau <span class="token operator">==</span> <span class="token number">0</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span> <span class="token function">Err</span><span class="token punctuation">(</span><span class="token string">&quot;tau can't == 0&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">if</span> <span class="token keyword">self</span><span class="token punctuation">.</span>reward_period_seconds <span class="token operator">&gt;</span> <span class="token number">365</span> <span class="token operator">*</span> <span class="token number">86400</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span> <span class="token function">Err</span><span class="token punctuation">(</span><span class="token string">&quot;reward period can't exceed 365 days&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">if</span> <span class="token keyword">self</span><span class="token punctuation">.</span>monetary_expansion_decay <span class="token operator">&gt;</span> <span class="token number">1_000_000</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span> <span class="token function">Err</span><span class="token punctuation">(</span><span class="token string">&quot;decay can't &gt; 1_000_000&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token function">Ok</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><h3 id="state"><a href="#state" class="header-anchor">#</a> State</h3> <div class="language-rust extra-class"><pre class="language-rust"><code><span class="token comment">/// Participate in the computation of app_hash, empty block should not modify</span>
<span class="token keyword">pub</span> <span class="token keyword">struct</span> RewardState <span class="token punctuation">{</span>
    <span class="token comment">/// Fees and slashings accumulated through current reward period</span>
    <span class="token keyword">pub</span> period_bonus<span class="token punctuation">:</span> Coin<span class="token punctuation">,</span>
    <span class="token comment">/// last block height that updated it</span>
    <span class="token keyword">pub</span> last_block_height<span class="token punctuation">:</span> BlockHeight<span class="token punctuation">,</span>
    <span class="token comment">/// last reward distribution time, default to the genesis time</span>
    <span class="token keyword">pub</span> last_distribution_time<span class="token punctuation">:</span> Timespec<span class="token punctuation">,</span>
    <span class="token comment">/// Record how many coins have been minted so far, shouldn't exceed the monetary_expansion_cap</span>
    <span class="token keyword">pub</span> minted<span class="token punctuation">:</span> Coin<span class="token punctuation">,</span>
    <span class="token comment">/// Current tau value of monetary expansion calculation</span>
    <span class="token keyword">pub</span> current_tau<span class="token punctuation">:</span> u64<span class="token punctuation">,</span>
<span class="token punctuation">}</span>

<span class="token keyword">pub</span> <span class="token keyword">struct</span> ValidatorState <span class="token punctuation">{</span>
    <span class="token punctuation">...</span>

    <span class="token comment">/// Records the participators for reward distribution, the value is the sum of voting powers for each signed vote of the participator</span>
    reward_participators<span class="token punctuation">:</span> HashMap<span class="token operator">&lt;</span>StakingAddress<span class="token punctuation">,</span> u64<span class="token operator">&gt;</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span>

<span class="token keyword">pub</span> <span class="token keyword">struct</span> ChainNodeApp <span class="token punctuation">{</span>
    <span class="token keyword">pub</span> reward_state_updated<span class="token punctuation">:</span> bool
<span class="token punctuation">}</span>
</code></pre></div><p>Use <code>u64</code> for the sum of voting powers is enough, because total staking powers is smaller than 10 billion, so if maximum staking powers participates in all the blocks, the number of blocks we can support before <code>u64</code> overflows is:</p> <div class="language- extra-class"><pre class="language-text"><code>&gt;&gt;&gt; 9223372036854775807 / 10000000000
922337203
</code></pre></div><p>It should be more than enough for one reward period, but still the implementation should avoid panic or wrap-around when overflows happen in extreme case.</p> <h3 id="predefined-symbols"><a href="#predefined-symbols" class="header-anchor">#</a> Predefined symbols</h3> <p>In the following sections, we use following predefined symbols:</p> <ul><li><code>reward_state</code> for the current <code>RewardState</code></li> <li><code>validator_state</code> for the current <code>ValidatorState</code></li> <li><code>node_state</code> for the current <code>ChainNodeApp</code></li> <li><code>network_parameter</code> for the current <code>NetworkParameter</code></li></ul> <h3 id="abci-events"><a href="#abci-events" class="header-anchor">#</a> ABCI Events</h3> <h4 id="begin-block"><a href="#begin-block" class="header-anchor">#</a> Begin block</h4> <p>The main actions all happens in begin block event, it's the time we get reports of participators through <code>last_commit_info</code>, also the time the node state is consistent.</p> <ol><li>Collect the validator addresses of reward participators from <code>last_commit_info</code>.</li> <li>Record them, and accumulate their voting powers.</li> <li>If a reward period has passed, distribute the reward pool according to the participator statistics.</li></ol> <h5 id="begin-block-2"><a href="#begin-block-2" class="header-anchor">#</a> <code>begin_block</code></h5> <div class="language-rust extra-class"><pre class="language-rust"><code><span class="token keyword">fn</span> <span class="token function">begin_block</span><span class="token punctuation">(</span>req<span class="token punctuation">:</span> RequestBeginBlock<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">let</span> addrs <span class="token operator">=</span> req<span class="token punctuation">.</span>last_commit_info<span class="token punctuation">.</span>votes
        <span class="token punctuation">.</span><span class="token function">filter</span><span class="token punctuation">(</span><span class="token operator">|</span>vote<span class="token operator">|</span> vote<span class="token punctuation">.</span>signed_last_block<span class="token punctuation">)</span>
        <span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span><span class="token operator">|</span>vote<span class="token operator">|</span> <span class="token function">get_validator_address</span><span class="token punctuation">(</span>vote<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">for</span> addr <span class="token keyword">in</span> addrs <span class="token punctuation">{</span>
        <span class="token comment">// Panic or not is decided by the implementator</span>
        <span class="token keyword">let</span> staking_addr <span class="token operator">=</span> <span class="token function">find_staking_address</span><span class="token punctuation">(</span>addr<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">unwrap</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// Panic or not is decided by the implementator</span>
        <span class="token keyword">let</span> power <span class="token operator">=</span> <span class="token function">get_voting_power</span><span class="token punctuation">(</span>staking_addr<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">unwrap</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">let</span> amount <span class="token operator">=</span> u64<span class="token punctuation">::</span><span class="token function">from</span><span class="token punctuation">(</span>power<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> validator_state<span class="token punctuation">.</span>reward_participators<span class="token punctuation">.</span><span class="token function">contains</span><span class="token punctuation">(</span>staking_addr<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment">// Use saturating_add for better robustness</span>
            validator_state<span class="token punctuation">.</span>reward_participators<span class="token punctuation">[</span>staking_addr<span class="token punctuation">]</span> <span class="token operator">+=</span> amount<span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
            validator_state<span class="token punctuation">.</span>reward_participators<span class="token punctuation">[</span>staking_addr<span class="token punctuation">]</span> <span class="token operator">=</span> amount<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// Use saturating_add for better robustness</span>
    <span class="token keyword">if</span> reward_state<span class="token punctuation">.</span>last_distribution_time <span class="token operator">+</span> network_parameter<span class="token punctuation">.</span>reward_period_seconds
        <span class="token operator">&gt;</span> node_state<span class="token punctuation">.</span>block_time <span class="token punctuation">{</span>
        <span class="token comment">// Don't distribute rewards if reward period not reached yet</span>
        <span class="token keyword">return</span> None<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    reward_state<span class="token punctuation">.</span>last_distribution_time <span class="token operator">=</span> node_state<span class="token punctuation">.</span>block_time<span class="token punctuation">;</span>

    <span class="token comment">// Mark the dirty flag as soon as reward period reached.</span>
    node_state<span class="token punctuation">.</span>rewards_pool_updated <span class="token operator">=</span> <span class="token keyword">true</span><span class="token punctuation">;</span>

    <span class="token keyword">let</span> minted <span class="token operator">=</span> <span class="token function">min</span><span class="token punctuation">(</span>
      <span class="token comment">// Use saturating_sub to prevent underflow</span>
      network_parameter<span class="token punctuation">.</span>monetary_expansion_cap <span class="token operator">-</span> reward_state<span class="token punctuation">.</span>minted<span class="token punctuation">,</span>
      <span class="token comment">// Refer to the following sections for the implementation</span>
      <span class="token function">monetary_expansion</span><span class="token punctuation">(</span>
          <span class="token comment">// Refer to the following sections for the implementation</span>
          <span class="token function">total_staking</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
          reward_state<span class="token punctuation">.</span>current_tau<span class="token punctuation">,</span>
          network_parameter<span class="token punctuation">.</span>monetary_expansion_r0<span class="token punctuation">,</span>
          network_parameter<span class="token punctuation">.</span>reward_period_seconds<span class="token punctuation">,</span>
      <span class="token punctuation">)</span>
    <span class="token punctuation">)</span><span class="token punctuation">;</span>
    reward_state<span class="token punctuation">.</span>minted <span class="token operator">+=</span> minted<span class="token punctuation">;</span>

    <span class="token comment">// Decay the tau parameter, use the overflow avoid method mentioned above</span>
    reward_state<span class="token punctuation">.</span>current_tau <span class="token operator">=</span> <span class="token function">mul_micro</span><span class="token punctuation">(</span>
        reward_state<span class="token punctuation">.</span>current_tau<span class="token punctuation">,</span>
        network_parameter<span class="token punctuation">.</span>monetary_expansion_decay<span class="token punctuation">,</span>
    <span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// Total reward pool for this period</span>
    <span class="token keyword">let</span> reward_pool <span class="token operator">=</span> reward_state<span class="token punctuation">.</span>period_bonus <span class="token operator">+</span> minted<span class="token punctuation">;</span>

    <span class="token comment">// Use saturating_add for better robustness</span>
    <span class="token keyword">let</span> sum_power <span class="token operator">=</span> validator_state<span class="token punctuation">.</span>reward_participators<span class="token punctuation">.</span><span class="token function">values</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">sum</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// Compute the rewards distribution,</span>
    <span class="token comment">// compute `reward_pool * power / sum_power` for each participator</span>
    <span class="token keyword">let</span> distribution <span class="token operator">=</span> <span class="token function">vec!</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> sum_power <span class="token operator">==</span> <span class="token number">0</span> <span class="token punctuation">{</span>
        <span class="token comment">// If there is zero participator, the newly minted coins should be left to the next period</span>
        reward_state<span class="token punctuation">.</span>period_bonus <span class="token operator">+=</span> minted<span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
        <span class="token comment">// Remaining coins after distribution</span>
        <span class="token keyword">let</span> remains <span class="token operator">=</span> reward_pool<span class="token punctuation">;</span>

        <span class="token keyword">for</span> <span class="token punctuation">(</span>addr<span class="token punctuation">,</span> power<span class="token punctuation">)</span> <span class="token keyword">in</span> validator_state<span class="token punctuation">.</span>reward_participators <span class="token punctuation">{</span>
            <span class="token comment">// Use some type bigger than u64 (e.g. u128) to prevent overflow of multiplication</span>
            <span class="token keyword">let</span> amount <span class="token operator">=</span> reward_pool <span class="token operator">*</span> power <span class="token operator">/</span> sum_power<span class="token punctuation">;</span>
            remains <span class="token operator">-=</span> amount<span class="token punctuation">;</span>
            distribution<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token punctuation">(</span>addr<span class="token punctuation">,</span> amount<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token comment">// Remains of distribution is left to the next period</span>
        reward_state<span class="token punctuation">.</span>period_bonus <span class="token operator">=</span> remains<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// Add the rewards to the accounts, implementation is in following sections</span>
    <span class="token function">add_rewards</span><span class="token punctuation">(</span>distribution<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// Clear rewards statistics</span>
    validator_state<span class="token punctuation">.</span>reward_participators<span class="token punctuation">.</span><span class="token function">clear</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// The Result (distribution, minted) should be written into block result event list</span>
<span class="token punctuation">}</span>
</code></pre></div><h5 id="monetary-expansion-2"><a href="#monetary-expansion-2" class="header-anchor">#</a> <code>monetary_expansion</code></h5> <p>TODO</p> <h5 id="total-staking-2"><a href="#total-staking-2" class="header-anchor">#</a> <code>total_staking</code></h5> <div class="language-rust extra-class"><pre class="language-rust"><code><span class="token keyword">fn</span> <span class="token function">total_staking</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">let</span> sum <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token keyword">for</span> staking_addr <span class="token keyword">in</span> validator_state<span class="token punctuation">.</span>validators <span class="token punctuation">{</span>
        <span class="token comment">// Panic or not is decided by implementator</span>
        <span class="token keyword">let</span> account <span class="token operator">=</span> <span class="token function">get_account</span><span class="token punctuation">(</span>staking_addr<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">unwrap</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        sum <span class="token operator">+=</span> account<span class="token punctuation">.</span>bonded<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    sum
<span class="token punctuation">}</span>
</code></pre></div><h5 id="add-rewards"><a href="#add-rewards" class="header-anchor">#</a> <code>add_rewards</code></h5> <div class="language-rust extra-class"><pre class="language-rust"><code><span class="token comment">// accounts should be stored in merkle trie, the details are ignored here.</span>
<span class="token keyword">fn</span> <span class="token function">add_rewards</span><span class="token punctuation">(</span>dist<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">for</span> staking_addr<span class="token punctuation">,</span> amount <span class="token keyword">in</span> dist <span class="token punctuation">{</span>
        <span class="token comment">// Panic or not is decided by implementator</span>
        <span class="token keyword">let</span> account <span class="token operator">=</span> <span class="token function">get_account</span><span class="token punctuation">(</span>staking_addr<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">unwrap</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        account<span class="token punctuation">.</span>bonded <span class="token operator">+=</span> amount<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><h4 id="commit"><a href="#commit" class="header-anchor">#</a> Commit</h4> <p>Update <code>last_block_height</code> if <code>RewardsPoolState</code> changed:</p> <div class="language-rust extra-class"><pre class="language-rust"><code><span class="token keyword">if</span> node_state<span class="token punctuation">.</span>reward_state_updated <span class="token punctuation">{</span>
    reward_state<span class="token punctuation">.</span>last_block_height <span class="token operator">=</span> current_block_height<span class="token punctuation">;</span>
    node_state<span class="token punctuation">.</span>reward_state_updated <span class="token operator">=</span> <span class="token keyword">false</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><h3 id="hooks"><a href="#hooks" class="header-anchor">#</a> Hooks</h3> <h4 id="when-validator-becomes-inactive-at-end-block"><a href="#when-validator-becomes-inactive-at-end-block" class="header-anchor">#</a> When validator becomes inactive at <code>end_block</code></h4> <p>When validator get jailed or unbonded enough to become inactive during a reward period, it's reward participation record should be removed, so it won't receive any rewards.</p> <div class="language-rust extra-class"><pre class="language-rust"><code>validator_state<span class="token punctuation">.</span>reward_participators<span class="token punctuation">.</span><span class="token function">remove</span><span class="token punctuation">(</span>staking_addr<span class="token punctuation">)</span>
</code></pre></div><h4 id="slashing-executed"><a href="#slashing-executed" class="header-anchor">#</a> Slashing executed</h4> <p>When slashing executed, the <code>slashed_amount</code> needs to be added to <code>period_bonus</code> of <code>RewardState</code>.</p> <div class="language-rust extra-class"><pre class="language-rust"><code>reward_state<span class="token punctuation">.</span>period_bonus <span class="token operator">+=</span> slashed_amount<span class="token punctuation">;</span>
node_state<span class="token punctuation">.</span>rewards_pool_updated <span class="token operator">=</span> <span class="token keyword">true</span><span class="token punctuation">;</span>
</code></pre></div><h4 id="fee-collected"><a href="#fee-collected" class="header-anchor">#</a> Fee collected</h4> <p>When transaction fees are collected, the amount needs to be added to <code>period_bonus</code> of <code>RewardState</code>.</p> <div class="language-rust extra-class"><pre class="language-rust"><code>reward_state<span class="token punctuation">.</span>period_bonus <span class="token operator">+=</span> fees<span class="token punctuation">;</span>
node_state<span class="token punctuation">.</span>rewards_pool_updated <span class="token operator">=</span> <span class="token keyword">true</span><span class="token punctuation">;</span>
</code></pre></div></div> <footer class="page-edit"><!----> <!----></footer> <!----> </main></div><div class="global-ui"></div></div>
    <script src="/assets/js/app.87b9d60e.js" defer></script><script src="/assets/js/2.f6144b7e.js" defer></script><script src="/assets/js/31.c62e85d2.js" defer></script>
  </body>
</html>
