<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Transaction Data Bootstrapping Enclave details | Crypto.com Chain</title>
    <meta name="generator" content="VuePress 1.5.2">
    
    <meta name="description" content="Welcome to Crypto.com Chain's documentation!">
    <link rel="preload" href="/assets/css/0.styles.04f4ab1f.css" as="style"><link rel="preload" href="/assets/js/app.4a812791.js" as="script"><link rel="preload" href="/assets/js/3.d9be86cb.js" as="script"><link rel="preload" href="/assets/js/1.031a9313.js" as="script"><link rel="preload" href="/assets/js/33.a2ebab91.js" as="script"><link rel="prefetch" href="/assets/js/10.4171635c.js"><link rel="prefetch" href="/assets/js/11.38c5f6b0.js"><link rel="prefetch" href="/assets/js/12.e842f2d1.js"><link rel="prefetch" href="/assets/js/13.b0283132.js"><link rel="prefetch" href="/assets/js/14.afd98677.js"><link rel="prefetch" href="/assets/js/15.98a07619.js"><link rel="prefetch" href="/assets/js/16.f50c4c2f.js"><link rel="prefetch" href="/assets/js/17.9f9d6518.js"><link rel="prefetch" href="/assets/js/18.560cff4c.js"><link rel="prefetch" href="/assets/js/19.eba0fd5d.js"><link rel="prefetch" href="/assets/js/20.c5446fb4.js"><link rel="prefetch" href="/assets/js/21.85b3b00d.js"><link rel="prefetch" href="/assets/js/22.b0604f1a.js"><link rel="prefetch" href="/assets/js/23.c3b06d1d.js"><link rel="prefetch" href="/assets/js/24.92dd2abc.js"><link rel="prefetch" href="/assets/js/25.0351523e.js"><link rel="prefetch" href="/assets/js/26.b3dfc3c7.js"><link rel="prefetch" href="/assets/js/27.607889ce.js"><link rel="prefetch" href="/assets/js/28.cc3d333a.js"><link rel="prefetch" href="/assets/js/29.de029e74.js"><link rel="prefetch" href="/assets/js/30.fbd2d55c.js"><link rel="prefetch" href="/assets/js/31.cbe44043.js"><link rel="prefetch" href="/assets/js/32.f088fb25.js"><link rel="prefetch" href="/assets/js/34.bb481af3.js"><link rel="prefetch" href="/assets/js/35.08dabcba.js"><link rel="prefetch" href="/assets/js/36.c71fef74.js"><link rel="prefetch" href="/assets/js/37.c3dbd3f3.js"><link rel="prefetch" href="/assets/js/4.3fadd12b.js"><link rel="prefetch" href="/assets/js/5.e32af655.js"><link rel="prefetch" href="/assets/js/6.a1edfeb1.js"><link rel="prefetch" href="/assets/js/7.c1d9286f.js"><link rel="prefetch" href="/assets/js/8.815de04f.js"><link rel="prefetch" href="/assets/js/9.51dde140.js">
    <link rel="stylesheet" href="/assets/css/0.styles.04f4ab1f.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container no-sidebar"><header class="navbar"><div class="redirect-overlay"><div class="logo"><img src="/chain_nav_logo.svg" alt="Crypto.com Chain" class="logotype"></div> <div class="redirect"><span>3</span> <img src="/moon.svg" alt="0" class="moon"> <span>2</span></div> <div class="desc"><span>The Crypto.com Chain documenation is now moved to <a href="https://chain.crypto.com/docs">https://chain.crypto.com/docs</a>. <br>
      You will be redirected in 10 seconds.</span></div> <div><a href="https://chain.crypto.com/docs" class="action-button">Redirect Now</a></div></div> <div class="inner"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="#0b1426" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/" class="home-link router-link-active"><img src="/chain_nav_logo.svg" alt="Crypto.com Chain" class="logotype can-hide"> <img src="/logo-icon.svg" alt="Crypto.com Chain" class="logoicon desktop-hide"> <!----></a> <div class="links"><nav class="nav-links can-hide"><div class="nav-item"><a href="/getting-started/" class="nav-link">Getting Started</a></div><div class="nav-item"><div class="dropdown-wrapper"><a class="dropdown-title"><span class="title">Thaler Testnet</span> <span class="arrow right"></span></a> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/getting-started/thaler-testnet.html" class="nav-link">Setup Tutorial</a></li><li class="dropdown-item"><!----> <a href="https://chain.crypto.com/explorer" target="_blank" rel="noopener noreferrer" class="nav-link external">
  Testnet Explorer
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li><li class="dropdown-item"><!----> <a href="https://chain.crypto.com/faucet" target="_blank" rel="noopener noreferrer" class="nav-link external">
  Testnet Faucet
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><a class="dropdown-title"><span class="title">Wallet Management</span> <span class="arrow right"></span></a> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/wallets/#client-cli" class="nav-link">Overview</a></li><li class="dropdown-item"><!----> <a href="/wallets/client-cli.html#client-cli" class="nav-link">Client CLI</a></li><li class="dropdown-item"><!----> <a href="/wallets/sample-chain-wallet.html#sample-chain-wallet" class="nav-link">Sample Chain Wallet</a></li><li class="dropdown-item"><!----> <a href="/wallets/client-rpc.html#client-rpc" class="nav-link">Client RPC</a></li></ul></div></div><div class="nav-item"><a href="https://crypto-com.github.io/Crypto.com_Chain.pdf" target="_blank" rel="noopener noreferrer" class="nav-link external">
  Download
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></div> <!----></nav> <div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div></div></div></header> <div class="sidebar-mask"></div> <div class="docs-layout"><aside class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/getting-started/" class="nav-link">Getting Started</a></div><div class="nav-item"><div class="dropdown-wrapper"><a class="dropdown-title"><span class="title">Thaler Testnet</span> <span class="arrow right"></span></a> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/getting-started/thaler-testnet.html" class="nav-link">Setup Tutorial</a></li><li class="dropdown-item"><!----> <a href="https://chain.crypto.com/explorer" target="_blank" rel="noopener noreferrer" class="nav-link external">
  Testnet Explorer
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li><li class="dropdown-item"><!----> <a href="https://chain.crypto.com/faucet" target="_blank" rel="noopener noreferrer" class="nav-link external">
  Testnet Faucet
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><a class="dropdown-title"><span class="title">Wallet Management</span> <span class="arrow right"></span></a> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/wallets/#client-cli" class="nav-link">Overview</a></li><li class="dropdown-item"><!----> <a href="/wallets/client-cli.html#client-cli" class="nav-link">Client CLI</a></li><li class="dropdown-item"><!----> <a href="/wallets/sample-chain-wallet.html#sample-chain-wallet" class="nav-link">Sample Chain Wallet</a></li><li class="dropdown-item"><!----> <a href="/wallets/client-rpc.html#client-rpc" class="nav-link">Client RPC</a></li></ul></div></div><div class="nav-item"><a href="https://crypto-com.github.io/Crypto.com_Chain.pdf" target="_blank" rel="noopener noreferrer" class="nav-link external">
  Download
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></div> <!----></nav>  <!----> </aside> <main class="page"> <div class="theme-default-content content__default"><h1 id="transaction-data-bootstrapping-enclave-details"><a href="#transaction-data-bootstrapping-enclave-details" class="header-anchor">#</a> Transaction Data Bootstrapping Enclave details</h1> <p>Transaction Validation Enclave (TVE):</p> <ul><li>responsible for validating Enclave tx types;</li> <li>holds current tx obfuscation key;</li> <li>reacts to <em>immediate</em> requests (chain-abci, i.e. potentially uncommitted or invalid transaction; encryption requests from tx-query enclave)</li> <li>chain-abci directly talks to it during (consensus) state-machine execution</li></ul> <p>Transaction Data Bootstrapping Enclave (TDBE):</p> <ul><li>responsible for generating MLSHandshake tx types;</li> <li>fetches old transaction data payloads;</li> <li>prerequisite for a node administrator to submit a node join tx request or construct genesis.json</li> <li>reacts to <em>block-committed</em> requests:
<ul><li>needs to run a Tendermint light client verification (TODO: trusted anchor injected as compile-time data?) and be connected to its Tendermint node RPC</li> <li>chain-abci does not talk to it (it may invoke it during startup / for fetching old tx data, but can't talk to it during state-machine execution)</li> <li>&quot;knows&quot; when it should generate MLSHandshake tx: 1) when in mid-time of keypackage expiration; 2) being &quot;leftmost&quot; node</li> <li>based on valid block-committed requests, it should update its internal states, derive secrets and push tx obfuscation key to TVE</li></ul></li></ul> <h2 id="new-rejoining-node"><a href="#new-rejoining-node" class="header-anchor">#</a> new/rejoining node</h2> <p>(for non-genesis specified ones)</p> <ul><li>submit council or community node join request TX</li> <li>if valid, wait until CommitChangeTx is committed with Welcome payload</li> <li>mark the block where this CommitChangeTx is committed as the &quot;fetched up to&quot; block
and obtain old transaction data</li></ul> <p>TODO: fetch keypackages/leaf nodes? https://github.com/mlswg/mls-protocol/issues/344</p> <h3 id="obtaining-old-transaction-data"><a href="#obtaining-old-transaction-data" class="header-anchor">#</a> Obtaining old transaction data</h3> <p>When a node is started up (before tendermint consensus syncing etc.), it should be provided
&quot;genesis-skip&quot; (in the case it's one of nodes starting at genesis)
or one or more connection strings
that would proxy to some public full node RPC.</p> <p>Via the Tendermint light-client-verifying connection, it should obtain the list of
needed transaction IDs (of withdrawal and transfer transactions):</p> <ul><li>full node / historical querying: all IDs between its last processed block and the last block on the remote node</li> <li>validator: new IDs in the &quot;UTXO set diff&quot; between its last processed block and the last block on the remote node
(TODO: https://github.com/crypto-com/chain/issues/794 ; initial implementation here can start with just &quot;all IDs&quot; for both)</li></ul> <p>From remote node RPC, it should also learn its TDBE connection details
and then initiate enclave-to-enclave mutually attested TLS: TODO https://github.com/crypto-com/chain/issues/1549
and fetch the needed transaction payloads and seal them for its host.</p> <p>TODO: handling in abci -- options (probably start with option 1):</p> <ol><li>record the &quot;fetched up to&quot; block;
report to TM still the last processed block
and run normal TM block-by-block syncing and skip tx-validation-enclave until the &quot;fetched up to&quot; block</li> <li>TM 0.34+ -- run state-sync for jellyfish merkle / staking state https://docs.tendermint.com/master/spec/abci/apps.html#state-sync
and resume from the &quot;fetched up to&quot; block?</li></ol> <h2 id="sealing-recovering"><a href="#sealing-recovering" class="header-anchor">#</a> Sealing / recovering</h2> <p>on genesis or when the (add/update) request is committed,
TDBE should seal its init key + credential + &quot;trusted anchor&quot; parts (app hash components, validator identities... block number)
with app hash (or some state fingerprint?) as AAD.</p> <p>Restarted TDBE (that wasn't kicked out) starts off this state via the TM light client</p> <h2 id="security-upgrades"><a href="#security-upgrades" class="header-anchor">#</a> Security upgrades</h2> <p>TDBE/chain-abci should keep track of the highest <code>isv_svn</code> observed
(in a valid committed tx) and reject Add/Update proposals with a lower number.
for (old) data bootstrapping:</p> <ul><li>TDBE (server): reject all TLS connections with lower <code>isv_svn</code> than the highest one</li> <li>TDBE (client): keep track keypackage <code>isv_svn</code> proportions (based on MLSHandshake messages);
<ul><li>if (highest <code>isv_svn</code> count / lower <code>isv_svn</code> count &gt;= 2/3), reject all TLS connections with lower <code>isv_svn</code> than the highest one</li> <li>otherwise, tolerate fetching data from servers where <code>isv_svn</code> == <code>the highest one - 1</code></li></ul></li></ul> <h3 id="svn-verification-compilation-order"><a href="#svn-verification-compilation-order" class="header-anchor">#</a> SVN verification + compilation order</h3> <p>Besides verifying <code>MRSIGNER</code>, ProductId, etc. is the same as in <code>Report::for_self()</code>, one should also verify:</p> <ul><li>TDBE: if (other party's <code>isv_svn</code>) == (my <code>isv_svn</code> / in the report), check MRENCLAVE is the same</li> <li>TVE: (incoming local connection's  <code>isv_svn</code>) == (my <code>isv_svn</code>) and MRENCLAVE is corresponding to compile-time encoded value of TQE or TDBE (depending on the expected connection type)</li></ul> <p>NOTE: as TVE only expects local communication, it should expect <code>isv_svn</code> to be exactly the same as its own
(the node operator would update all binaries at once on its node).</p> <p>This mandates the following compilation / signing order:</p> <ol><li>TDBE</li> <li>TQE</li> <li>TVE: (provided TDBE's and TQE's MRENCLAVE values at compile-time)</li></ol> <h2 id="obfuscation-key-rotation-via-message-layer-security-handshakes"><a href="#obfuscation-key-rotation-via-message-layer-security-handshakes" class="header-anchor">#</a> Obfuscation key rotation via Message Layer Security handshakes</h2> <h3 id="data-type-modifications"><a href="#data-type-modifications" class="header-anchor">#</a> data type modifications</h3> <div class="language-rust extra-class"><pre class="language-rust"><code><span class="token keyword">struct</span> StakedState <span class="token punctuation">{</span>
    address<span class="token punctuation">:</span> StakedStateAddress<span class="token punctuation">,</span>
    nonce<span class="token punctuation">:</span> u64<span class="token punctuation">,</span>
    bonded<span class="token punctuation">:</span> Coin<span class="token punctuation">,</span>
    unbonded<span class="token punctuation">:</span> Coin<span class="token punctuation">,</span>
    unbonded_from<span class="token punctuation">:</span> Timespec<span class="token punctuation">,</span>
    node_details<span class="token punctuation">:</span> Option<span class="token operator">&lt;</span>NodeDetails<span class="token operator">&gt;</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span>

<span class="token keyword">enum</span> NodeDetails <span class="token punctuation">{</span>
    <span class="token function">Council</span><span class="token punctuation">(</span>Validator<span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token function">Community</span><span class="token punctuation">(</span>FullNode<span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token keyword">struct</span> FullNode <span class="token punctuation">{</span>
    council_node<span class="token punctuation">:</span> CommunityNode<span class="token punctuation">,</span>
    jailed_until<span class="token punctuation">:</span> Option<span class="token operator">&lt;</span>Timespec<span class="token operator">&gt;</span><span class="token punctuation">,</span> <span class="token comment">// TODO: should there be jailing? for invalid handshake tx submission?</span>
    inactive_time<span class="token punctuation">:</span> Option<span class="token operator">&lt;</span>Timespec<span class="token operator">&gt;</span><span class="token punctuation">,</span> <span class="token comment">// TODO: when missing submitting handshake tx? should validator have 2 &quot;inactive times&quot;?</span>
<span class="token punctuation">}</span>

<span class="token keyword">pub</span> <span class="token keyword">struct</span> CommunityNode <span class="token punctuation">{</span>
    <span class="token keyword">pub</span> name<span class="token punctuation">:</span> Name<span class="token punctuation">,</span>    <span class="token comment">/// name / moniker (just for reference / human use)</span>
    <span class="token keyword">pub</span> security_contact<span class="token punctuation">:</span> Contact<span class="token punctuation">,</span>    <span class="token comment">/// optional security@... email address</span>
    <span class="token keyword">pub</span> confidential_init<span class="token punctuation">:</span> ConfidentialInit<span class="token punctuation">,</span> <span class="token comment">// contains the keypackage</span>
<span class="token punctuation">}</span>
</code></pre></div><h3 id="extra-network-params"><a href="#extra-network-params" class="header-anchor">#</a> extra network params</h3> <ul><li>community node minimal required stake</li> <li>mls handshake commit timeout</li> <li>mls handshake message NACK timeout</li> <li>slash rate for invalid commits?</li> <li>keypackage expiration time (as there are consensus-related rules --
e.g. when to remove nodes with expired keypackages whose TDBE failed to submit update in time;
when/how often update can be submitted -- it probably should be a consensus parameter)</li></ul> <h3 id="genesis-json-creation"><a href="#genesis-json-creation" class="header-anchor">#</a> genesis.json creation</h3> <p>The genesis generation ceremony needs to happen in several steps:</p> <ol><li><p>Keypackage-independent parameters are exchanged/specified as compile-time parameters (for the light client trusted anchor basis)</p></li> <li><p>enclave code is compiled with these parameters and signed on by the production key</p></li> <li><p>administrators of nodes participating from genesis obtain and verify the signed binaries and use them to generate their keypackages</p></li> <li><p>they exchange keypackages</p></li> <li><p>leftmost / first validator's node administrator is responsible for generating the first MLSHandshake CommitChange that's included in genesis.json
and generating and distributing genesis.json (that's verified by other parties)</p></li></ol> <h3 id="extra-tx-types"><a href="#extra-tx-types" class="header-anchor">#</a> extra TX types</h3> <div class="language- extra-class"><pre class="language-text"><code>Enclave
  ...
Public
  ...
  NodeJoin
MLSHandshake
  CommitChange
  SelfUpdateProposal
  MsgNack
</code></pre></div><p>NodeJoin is extended that instead of taking <code>CouncilNode</code>, it'd take <code>NodeMetadata</code> which is enum
with council node and community node variants.
TODO: extra rules for CouncilNode -&gt; CommunityNode (needs to unbond / become inactive first?)</p> <h4 id="handshake-transactions"><a href="#handshake-transactions" class="header-anchor">#</a> Handshake transactions</h4> <p>internal <code>Vec&lt;u8&gt;</code> payloads are expected to be encoded in the TLS standard binary encodings
(TODO:
<a href="https://github.com/mlswg/mls-architecture/blob/master/draft-ietf-mls-architecture.md" target="_blank" rel="noopener noreferrer">the draft MLS architecture doc<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>:</p> <blockquote><p>In addition, it does not specify a complete wire encoding, but rather a set of abstract data structures which can then be mapped onto a variety of concrete encodings, such as TLS RFC8446, CBOR RFC7049, and JSON RFC7159.</p></blockquote> <p>Besides X.509 (to reuse TLS RA stuff) identities in keypackages, we may potentially switch to SCALE to keep it simpler;
TLS wire format is mainly interesting for test-vectors / unit tests, but the protocol draft is too in flux at the moment.
).</p> <div class="language-rust extra-class"><pre class="language-rust"><code><span class="token keyword">pub</span> <span class="token keyword">struct</span> CommitChangeTx <span class="token punctuation">{</span>
    messages<span class="token punctuation">:</span> Vec<span class="token operator">&lt;</span>Vec<span class="token operator">&lt;</span>u8<span class="token operator">&gt;&gt;</span><span class="token punctuation">,</span> <span class="token comment">// MLSPlaintext -- any proposals (Add or Remove), the last one is assumed to be Commit</span>
    welcome<span class="token punctuation">:</span> Option<span class="token operator">&lt;</span>Vec<span class="token operator">&lt;</span>u8<span class="token operator">&gt;&gt;</span><span class="token punctuation">,</span> <span class="token comment">// Welcome -- if there are any Add proposals, there should be a welcome with encrypted paths/epochs for new joiners</span>
<span class="token punctuation">}</span>
</code></pre></div><div class="language-rust extra-class"><pre class="language-rust"><code><span class="token keyword">pub</span> <span class="token keyword">struct</span> SelfUpdateProposal <span class="token punctuation">{</span>
    proposal<span class="token punctuation">:</span> Vec<span class="token operator">&lt;</span>u8<span class="token operator">&gt;</span><span class="token punctuation">,</span> <span class="token comment">// MLSPlaintext -- Update</span>
    commit<span class="token punctuation">:</span> Vec<span class="token operator">&lt;</span>u8<span class="token operator">&gt;</span><span class="token punctuation">,</span> <span class="token comment">// MLSPlaintext -- Commit</span>
<span class="token punctuation">}</span>
</code></pre></div><div class="language-rust extra-class"><pre class="language-rust"><code><span class="token keyword">pub</span> <span class="token keyword">struct</span> MsgNack <span class="token punctuation">{</span>
    nack<span class="token punctuation">:</span> Vec<span class="token operator">&lt;</span>u8<span class="token operator">&gt;</span><span class="token punctuation">,</span> <span class="token comment">// msg ref + `zz` + DLEQ proof -- TBD: https://github.com/mlswg/mls-protocol/issues/21#issuecomment-455392023</span>
<span class="token punctuation">}</span>
</code></pre></div><p>(TODO: <code>CommitChangeTx</code> / <code>SelfUpdateProposal</code> may need to contain Schnorr NIZK of knowledge (RFC 8235)
for encrypted parts (<code>Welcome</code>, <code>DirectPathNode</code>...))</p> <h5 id="tdbe-handling-generation"><a href="#tdbe-handling-generation" class="header-anchor">#</a> TDBE handling / generation</h5> <p>TDBE runs as a standalone enclave which includes TM light client and reacts to information received from it.
For fetched transactions with MLS handshake messages, it should verify they are valid (i.e. their TXID is a leaf in the Merkle tree
of valid transactions in a particular block).
It opens mutually attested TLS connection to tx-validation enclave (TVE) for pushing exported obfuscation keys.</p> <h6 id="commits"><a href="#commits" class="header-anchor">#</a> Commits</h6> <p>When a block is committed with nodejoin, unbond or punishment events (liveness/byzantine issues, bue also including expired keypackages),
Node's TDBE corresponding to the leftmost non-empty leaf should generate and broadcast <code>CommitChangeTx</code> with proposals reflecting the triggering block's change (Add/Remove).</p> <p>[[ TODO: instead of leftmost non-empty leaf, start with <code>triggering block time ``mod`` leaf_count</code> closest non-empty to the right circulating to 0 ? ]]</p> <p>(It should use the triggering block's number as AAD.)
If there are only Add proposals (post-genesis/group creation), populating the path can be omitted.</p> <p>If CommitChangeTx is not received in a block with time less the triggering block's time + timeout,
OR received CommitChangeTx was invalid;</p> <p>node's TDBE corresponding to the next leftmost non-empty leaf should generate and broadcast <code>CommitChangeTx</code> -- it should include
a Remove proposal for the previous node(s) (that failed to submit in time or submitted invalid <code>CommitChangeTx</code>;
it should be indicated in timeout-committed block
);
and include any additional proposals (if any) since the original triggering block;
(it should take the latest &quot;timeout&quot; block's number as AAD.)</p> <p>Commit (in <code>CommitChangeTx</code> / <code>SelfUpdateProposal</code>) should be applied after NACK timeout.</p> <h6 id="nack"><a href="#nack" class="header-anchor">#</a> NACK</h6> <p>If the receiver of the <code>HPKECiphertext</code> (Welcome message or DirectPath) cannot process it
/ it fails (e.g. the encrypted secret does not match the outside public key),
they generate and broadcast a message that
reveals <code>dh</code> value and provides a proof <code>DLEQ(dh/kem_output == node_hpke_public_key/group_point)</code>
(ref: https://blog.cloudflare.com/privacy-pass-the-math/).</p> <p>If NACK is valid and submitted in time, the Commit-containing message should be considered as invalid
(even though the corresponding TX was assumed as valid before) -- the punishment logic should be applied
to the related message submitter;
the next node's TDBE (next non-empty leaf) should generate and broadcast <code>CommitChangeTx</code>
and include Remove proposals as with the &quot;commit timeout&quot; case.</p> <h6 id="updates"><a href="#updates" class="header-anchor">#</a> Updates</h6> <p>After 1/3 of keypackage's lifetime is over, TDBE is allowed to generate and broadcast <code>SelfUpdateProposal</code></p> <p>-- it may happen that there's another committed <code>SelfUpdateProposal</code> (from a different sender) or <code>CommitChangeTx</code>,
which makes TDBE's original <code>SelfUpdateProposal</code> -- in which case, it should re-generate and retry.</p> <h6 id="new-obfuscation-key"><a href="#new-obfuscation-key" class="header-anchor">#</a> new obfuscation key</h6> <p>Once the Commit is applied (or state is reconstructed from Welcome), TDBE should generate a new obfuscation key as:</p> <div class="language- extra-class"><pre class="language-text"><code>new_key = MLS-Exporter(
    Label=&quot;Crypto.com Chain tx validation &quot; + block number where CommitChangeTx is included,
    Context=(that updated group's context),
    length=(AES_128_GCM_SIV key length)
)
</code></pre></div><p>and it should push it over mutually attested TLS to TVE.
TVE should delete old key after being pushed the new key.</p> <p>As with https://github.com/mlswg/mls-protocol/blob/master/draft-ietf-mls-protocol.md#deletion-schedule</p> <p>TDBE should delete the secrets + exported key after it's been pushed to TVE.</p> <h5 id="abci-processing"><a href="#abci-processing" class="header-anchor">#</a> abci processing</h5> <p>In MLS Architecture terminology:</p> <ul><li>Tendermint serves as Delivery Service (DS)</li> <li>IAS/DCAP/... + Tendermint (staking states) serve as Authentication Service (AS)</li></ul> <p>As such, abci app (chain-abci) needs to have some understanding of the logic of <code>MLSHandshake</code> transaction types.</p> <p>Notably, it needs:</p> <ul><li>to keep track of (MLS) Leaf<code>&lt;-&gt;</code>staking address mapping in order to execute corresponding updates on stake</li> <li>to keep track of keypackage lifetimes -- to limit frequency / know when <code>SelfUpdateProposal</code> are valid; for validators whose corresponding keypackage expires,
they should be removed from the validator set (similar to liveness fault handling)</li> <li>to keep track if valid <code>CommitChangeTx</code> was received in time -- invalid one receive similar treatment as byzantine faults (removal from validator set if a validator + slash)</li> <li>to keep track if valid <code>NACK</code> was received after a &quot;valid&quot; <code>CommitChangeTx</code> -- NACK invalidating <code>CommitChangeTx</code> should treat the <code>CommitChangeTx</code> similar to byzantine faults</li> <li>after <code>CommitChangeTx</code> -- after block commit and NACK timeout, enquire TVE if it was pushed a new key;
if not, it is a local node problem (e.g. no running TDBE) -- TODO: block consensus state machine or shutdown?</li></ul> <p>[[ OPEN ISSUE:
https://github.com/mlswg/mls-protocol/issues/21</p> <p>update the NACK solution here with the official one when it is drafted in the protocol spec
]]</p></div> <footer class="page-edit"><!----> <!----></footer> <!----> </main></div> <footer class="footer"><div class="wrapper"><div class="main"><div class="logo"><a href="/"><img src="/logotype-white.svg" alt="logo-icon-white" class="footer-logo"></a></div> <div class="navLinks"><div class="column"><h3>Developers</h3> <div class="link"><a href="/explorer">
              Explorer
            </a></div> <div class="link"><a href="/docs">
              Documentation
            </a></div></div> <div class="column"><h3>Tools</h3> <div class="link"><a href="/docs/wallets/">
              Wallet
            </a></div> <div class="link"><a href="/faucet">
              Faucet
            </a></div></div> <div class="column"><h3>Partners</h3> <div class="link"><a href="/partners">
              Partners
            </a></div></div> <div class="column"><h3>Community</h3> <div class="link"><a href="/community">
              Community
            </a></div></div></div> <div class="socials"><a target="_blank" rel="noopener noreferrer" href="https://twitter.com/cryptocom"><img src="/social/twitter.svg" alt="twitter"></a> <a target="_blank" rel="noopener noreferrer" href="https://www.facebook.com/CryptoComOfficial"><img src="/social/facebook.svg" alt="facebook"></a> <a target="_blank" rel="noopener noreferrer" href="https://www.instagram.com/cryptocomofficial/"><img src="/social/instagram.svg" alt="instagram"></a> <a target="_blank" rel="noopener noreferrer" href="https://hk.linkedin.com/company/cryptocom"><img src="/social/linkedin.svg" alt="linkedin"></a> <a target="_blank" rel="noopener noreferrer" href="https://www.youtube.com/channel/UCOMprzxakZOqmY23LYIawmg"><img src="/social/youtube.svg" alt="youtube"></a> <a target="_blank" rel="noopener noreferrer" href="https://www.reddit.com/r/Crypto_com/"><img src="/social/reddit.svg" alt="reddit"></a> <a target="_blank" rel="noopener noreferrer" href="https://discord.gg/nsp9JTC"><img src="/social/discord.svg" alt="discord"></a> <a target="_blank" rel="noopener noreferrer" href="https://t.me/CryptoComOfficial"><img src="/social/telegram.svg" alt="telegram"></a> <a target="_blank" rel="noopener noreferrer" href="https://open.kakao.com/o/gGH1WQM"><img src="/social/kakaotalk.svg" alt="kakaotalk"></a></div></div> <p class="copyright">
      Copyright © 2018 - 2020 Crypto.com. All rights reserved.
    </p></div></footer></div><div class="global-ui"></div></div>
    <script src="/assets/js/app.4a812791.js" defer></script><script src="/assets/js/3.d9be86cb.js" defer></script><script src="/assets/js/1.031a9313.js" defer></script><script src="/assets/js/33.a2ebab91.js" defer></script>
  </body>
</html>
